# Data Model

This document defines the **data structures** and **relationships** needed for the Planning Poker application, derived from `spec.MD`. It supports the spec-driven workflow defined in `configuration.MD`.

---

## 1. Overview

The data model supports:
- **MVP:** Rooms, participants (anonymous), items, votes, rounds, and session history (in-memory or SQLite).
- **Post-MVP:** User accounts, persistent history, and enhanced analytics.

**Design principles:**
- Votes remain secret until reveal (business rule).
- Each item has exactly one final estimate (business rule).
- MVP supports anonymous participation; accounts are optional.
- Real-time updates via WebSockets require efficient queries for presence and vote state.

---

## 2. Core Entities

### 2.1 Room

A single estimation session. Created by a facilitator; participants join via shareable link.

| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| `id` | `string` (UUID) | Primary key, unique | Generated by system; used in shareable link. |
| `name` | `string` | Required, max 200 chars | User-provided room name. |
| `deckType` | `enum` | Required | `FIBONACCI`, `LINEAR`, `TSHIRT` (MVP); extensible. |
| `deckValues` | `string[]` | Required | Card values for this deck (e.g. `["0", "1", "2", "3", "5", "8", "13", "21"]`). |
| `deckDescriptions` | `Record<string, string>` | Optional | Map of card value → description (e.g. `{ "5": "~1 day", "8": "complex" }`). Hidden from participants until reveal. |
| `state` | `enum` | Required, default `OPEN` | `OPEN`, `CLOSED`. |
| `facilitatorId` | `string` (UUID) | Required | References `Participant.id` (the creator). |
| `createdAt` | `timestamp` | Required | When room was created. |
| `closedAt` | `timestamp` | Nullable | When facilitator closed the room. |
| `userId` | `string` (UUID) | Nullable (post-MVP) | If facilitator has account; links to `User.id`. |

**Indexes:** `id` (primary), `facilitatorId`, `userId` (post-MVP), `state`, `createdAt`.

**Relationships:**
- One room → many participants (`Participant.roomId`).
- One room → many items (`Item.roomId`).
- One room → one session (`Session.roomId`).

---

### 2.2 Participant

A user in a room (facilitator, participant, or observer). MVP: identified by display name only; post-MVP: linked to account.

| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| `id` | `string` (UUID) | Primary key, unique | Generated on join. |
| `roomId` | `string` (UUID) | Required, foreign key | References `Room.id`. |
| `displayName` | `string` | Required, max 100 chars | Name shown to others; unique per room (or allow duplicates with disambiguation). |
| `role` | `enum` | Required, default `PARTICIPANT` | `FACILITATOR`, `PARTICIPANT`, `OBSERVER`. |
| `joinedAt` | `timestamp` | Required | When participant joined. |
| `leftAt` | `timestamp` | Nullable | When participant left (if before room closed). |
| `isActive` | `boolean` | Required, default `true` | Currently in room (for presence). |
| `userId` | `string` (UUID) | Nullable (post-MVP) | If participant has account; links to `User.id`. |
| `sessionId` | `string` (UUID) | Nullable | WebSocket session ID for real-time updates. |

**Indexes:** `id` (primary), `roomId`, `userId` (post-MVP), `isActive`, `role`.

**Relationships:**
- Many participants → one room (`Participant.roomId`).
- One participant → many votes (`Vote.participantId`).
- One participant → one user (post-MVP, `Participant.userId` → `User.id`).

**Business rules:**
- Only one facilitator per room (the creator).
- Observer cannot vote (`role = OBSERVER` → no votes allowed).
- `isActive = false` when `leftAt` is set or on disconnect.

---

### 2.3 Item

A work item being estimated (e.g. user story, task). Belongs to a room; has one final estimate.

| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| `id` | `string` (UUID) | Primary key, unique | Generated on creation. |
| `roomId` | `string` (UUID) | Required, foreign key | References `Room.id`. |
| `title` | `string` | Required, max 200 chars | Item title. |
| `description` | `string` | Nullable, max 2000 chars | Optional description. |
| `order` | `integer` | Required | Display order in room (1, 2, 3...). |
| `finalEstimate` | `string` | Nullable | Final estimate value (from deck); set when facilitator records it. |
| `finalEstimateRecordedAt` | `timestamp` | Nullable | When final estimate was recorded. |
| `createdAt` | `timestamp` | Required | When item was added. |
| `currentRoundId` | `string` (UUID) | Nullable | References `Round.id` for the active voting round. |

**Indexes:** `id` (primary), `roomId`, `order`, `finalEstimateRecordedAt`.

**Relationships:**
- Many items → one room (`Item.roomId`).
- One item → many rounds (`Round.itemId`).
- One item → one current round (`Item.currentRoundId` → `Round.id`).

**Business rules:**
- `finalEstimate` must be from the room’s `deckValues`.
- Only one final estimate per item (enforced by `finalEstimate` being a single value).
- Items can be edited before voting starts (before first round).

---

### 2.4 Round

One voting cycle for an item. Created when voting starts; can have multiple rounds per item (re-votes).

| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| `id` | `string` (UUID) | Primary key, unique | Generated on creation. |
| `itemId` | `string` (UUID) | Required, foreign key | References `Item.id`. |
| `roundNumber` | `integer` | Required | 1, 2, 3... per item (1 = first vote, 2 = re-vote, etc.). |
| `state` | `enum` | Required, default `VOTING` | `VOTING`, `REVEALED`, `FINALIZED`. |
| `votesRevealedAt` | `timestamp` | Nullable | When facilitator revealed votes. |
| `createdAt` | `timestamp` | Required | When round started. |
| `finalizedAt` | `timestamp` | Nullable | When final estimate was recorded (if applicable). |

**Indexes:** `id` (primary), `itemId`, `roundNumber`, `state`.

**Relationships:**
- Many rounds → one item (`Round.itemId`).
- One round → many votes (`Vote.roundId`).

**Business rules:**
- Votes are secret until `state = REVEALED`.
- Only facilitator can change `state` from `VOTING` → `REVEALED`.
- `roundNumber` increments for each re-vote on the same item.

---

### 2.5 Vote

A single vote cast by a participant in a round. Secret until round is revealed.

| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| `id` | `string` (UUID) | Primary key, unique | Generated on vote. |
| `roundId` | `string` (UUID) | Required, foreign key | References `Round.id`. |
| `participantId` | `string` (UUID) | Required, foreign key | References `Participant.id`. |
| `cardValue` | `string` | Required | Value from room’s `deckValues` (e.g. `"8"`, `"M"`). |
| `votedAt` | `timestamp` | Required | When vote was cast. |
| `isRevealed` | `boolean` | Required, default `false` | Whether vote has been revealed (derived from `Round.state`). |

**Indexes:** `id` (primary), `roundId`, `participantId`, `(roundId, participantId)` (unique constraint: one vote per participant per round).

**Relationships:**
- Many votes → one round (`Vote.roundId`).
- Many votes → one participant (`Vote.participantId`).

**Business rules:**
- One vote per participant per round (enforced by unique index).
- Facilitator can vote like participants; their vote is secret until reveal.
- Participant and facilitator can change vote before reveal (update `cardValue` and `votedAt`).
- `cardValue` must be in room’s `deckValues`.
- Observer cannot vote (enforced by application logic checking `Participant.role`).

**Computed fields (for reveal):**
- `average`: Average of numeric card values (if deck supports it).
- `median`: Median of numeric card values.
- `highest`: Maximum value.
- `lowest`: Minimum value.
- `suggestedEstimate`: Rounded average (up or down based on fractional part; e.g. 7.2 → 7, 7.8 → 8).
- `voteDistribution`: Map of card value → count (e.g. `{ "5": 3, "8": 2, "13": 1 }`).

---

### 2.6 Session

Represents a completed or active room session. Used for history and reporting.

| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| `id` | `string` (UUID) | Primary key, unique | Generated on room creation. |
| `roomId` | `string` (UUID) | Required, unique, foreign key | References `Room.id` (1:1). |
| `startedAt` | `timestamp` | Required | When room was created (same as `Room.createdAt`). |
| `closedAt` | `timestamp` | Nullable | When room was closed (same as `Room.closedAt`). |
| `facilitatorId` | `string` (UUID) | Required | References `Participant.id` (denormalized for queries). |
| `facilitatorName` | `string` | Required | Display name of facilitator (denormalized). |
| `totalItems` | `integer` | Required, default 0 | Count of items estimated. |
| `totalParticipants` | `integer` | Required, default 0 | Count of unique participants. |
| `userId` | `string` (UUID) | Nullable (post-MVP) | If facilitator has account; links to `User.id`. |

**Indexes:** `id` (primary), `roomId` (unique), `userId` (post-MVP), `closedAt`, `startedAt`.

**Relationships:**
- One session → one room (`Session.roomId` → `Room.id`).
- One session → one facilitator (`Session.facilitatorId` → `Participant.id`).

**Note:** Session can be created on room creation or lazily when room is closed (MVP choice).

---

### 2.7 User (Post-MVP)

User account for authentication and persistent history.

| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| `id` | `string` (UUID) | Primary key, unique | Generated on account creation. |
| `email` | `string` | Required, unique | User email (login). |
| `passwordHash` | `string` | Required | Hashed password (bcrypt/argon2). |
| `name` | `string` | Required, max 100 chars | User’s display name. |
| `createdAt` | `timestamp` | Required | When account was created. |
| `lastLoginAt` | `timestamp` | Nullable | Last login timestamp. |

**Indexes:** `id` (primary), `email` (unique).

**Relationships:**
- One user → many rooms (as facilitator, `Room.userId`).
- One user → many participants (`Participant.userId`).
- One user → many sessions (`Session.userId`).

---

## 3. Enums

### 3.1 RoomState

```typescript
enum RoomState {
  OPEN = "OPEN",      // Room is active; voting can occur
  CLOSED = "CLOSED"   // Room is closed; no new votes
}
```

### 3.2 DeckType

```typescript
enum DeckType {
  FIBONACCI = "FIBONACCI",  // 0, 1, 2, 3, 5, 8, 13, 21, ?, ☕
  LINEAR = "LINEAR",        // 0-10
  TSHIRT = "TSHIRT"         // XS, S, M, L, XL
}
```

### 3.3 ParticipantRole

```typescript
enum ParticipantRole {
  FACILITATOR = "FACILITATOR",  // Room creator; can reveal, re-vote, close
  PARTICIPANT = "PARTICIPANT",  // Can vote
  OBSERVER = "OBSERVER"          // Can watch; cannot vote
}
```

### 3.4 RoundState

```typescript
enum RoundState {
  VOTING = "VOTING",      // Votes are secret; participants can vote/change
  REVEALED = "REVEALED",  // Votes are visible; facilitator can record final estimate
  FINALIZED = "FINALIZED" // Final estimate recorded; round complete
}
```

---

## 4. Relationships Summary

```
Room (1) ──< (many) Participant
Room (1) ──< (many) Item
Room (1) ── (1) Session
Item (1) ──< (many) Round
Round (1) ──< (many) Vote
Participant (1) ──< (many) Vote
User (1) ──< (many) Room (post-MVP)
User (1) ──< (many) Participant (post-MVP)
User (1) ──< (many) Session (post-MVP)
```

---

## 5. MVP Data Storage

**MVP:** In-memory (e.g. Map/Set in Node.js) or SQLite.

**In-memory example (TypeScript):**
```typescript
interface DataStore {
  rooms: Map<string, Room>;
  participants: Map<string, Participant>;
  items: Map<string, Item>;
  rounds: Map<string, Round>;
  votes: Map<string, Vote>;
  sessions: Map<string, Session>;
}
```

**SQLite schema:** See §6 below.

**Post-MVP:** Migrate to Postgres for persistence, user accounts, and history.

---

## 6. SQL Schema (MVP - SQLite)

```sql
-- Rooms
CREATE TABLE rooms (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  deck_type TEXT NOT NULL CHECK (deck_type IN ('FIBONACCI', 'LINEAR', 'TSHIRT')),
  deck_values TEXT NOT NULL, -- JSON array: ["0", "1", "2", ...]
  deck_descriptions TEXT, -- JSON object: {"5": "~1 day", "8": "complex"}; optional; hidden until reveal
  state TEXT NOT NULL DEFAULT 'OPEN' CHECK (state IN ('OPEN', 'CLOSED')),
  facilitator_id TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  closed_at INTEGER,
  user_id TEXT -- Post-MVP
);

-- Participants
CREATE TABLE participants (
  id TEXT PRIMARY KEY,
  room_id TEXT NOT NULL REFERENCES rooms(id) ON DELETE CASCADE,
  display_name TEXT NOT NULL,
  role TEXT NOT NULL DEFAULT 'PARTICIPANT' CHECK (role IN ('FACILITATOR', 'PARTICIPANT', 'OBSERVER')),
  joined_at INTEGER NOT NULL,
  left_at INTEGER,
  is_active INTEGER NOT NULL DEFAULT 1 CHECK (is_active IN (0, 1)),
  user_id TEXT, -- Post-MVP
  session_id TEXT -- WebSocket session
);

-- Items
CREATE TABLE items (
  id TEXT PRIMARY KEY,
  room_id TEXT NOT NULL REFERENCES rooms(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT,
  "order" INTEGER NOT NULL,
  final_estimate TEXT,
  final_estimate_recorded_at INTEGER,
  created_at INTEGER NOT NULL,
  current_round_id TEXT
);

-- Rounds
CREATE TABLE rounds (
  id TEXT PRIMARY KEY,
  item_id TEXT NOT NULL REFERENCES items(id) ON DELETE CASCADE,
  round_number INTEGER NOT NULL,
  state TEXT NOT NULL DEFAULT 'VOTING' CHECK (state IN ('VOTING', 'REVEALED', 'FINALIZED')),
  votes_revealed_at INTEGER,
  created_at INTEGER NOT NULL,
  finalized_at INTEGER,
  UNIQUE(item_id, round_number)
);

-- Votes
CREATE TABLE votes (
  id TEXT PRIMARY KEY,
  round_id TEXT NOT NULL REFERENCES rounds(id) ON DELETE CASCADE,
  participant_id TEXT NOT NULL REFERENCES participants(id) ON DELETE CASCADE,
  card_value TEXT NOT NULL,
  voted_at INTEGER NOT NULL,
  is_revealed INTEGER NOT NULL DEFAULT 0 CHECK (is_revealed IN (0, 1)),
  UNIQUE(round_id, participant_id)
);

-- Sessions
CREATE TABLE sessions (
  id TEXT PRIMARY KEY,
  room_id TEXT NOT NULL UNIQUE REFERENCES rooms(id) ON DELETE CASCADE,
  started_at INTEGER NOT NULL,
  closed_at INTEGER,
  facilitator_id TEXT NOT NULL,
  facilitator_name TEXT NOT NULL,
  total_items INTEGER NOT NULL DEFAULT 0,
  total_participants INTEGER NOT NULL DEFAULT 0,
  user_id TEXT -- Post-MVP
);

-- Indexes
CREATE INDEX idx_rooms_facilitator ON rooms(facilitator_id);
CREATE INDEX idx_rooms_state ON rooms(state);
CREATE INDEX idx_participants_room ON participants(room_id);
CREATE INDEX idx_participants_active ON participants(is_active);
CREATE INDEX idx_items_room ON items(room_id);
CREATE INDEX idx_items_order ON items(room_id, "order");
CREATE INDEX idx_rounds_item ON rounds(item_id);
CREATE INDEX idx_votes_round ON votes(round_id);
CREATE INDEX idx_votes_participant ON votes(participant_id);
CREATE INDEX idx_sessions_user ON sessions(user_id); -- Post-MVP
```

---

## 7. Real-Time State (WebSocket)

For real-time updates, maintain:

- **Presence:** `Map<roomId, Set<participantId>>` — who is currently in each room.
- **Vote counts:** `Map<roundId, number>` — how many participants have voted (without revealing values).
- **Active rounds:** `Map<itemId, roundId>` — current voting round per item.

These can be derived from the data model but cached for performance.

---

## 8. Computed Fields & Queries

### 8.1 Vote Statistics (on reveal)

For a `Round`, compute:
- `average`: Average of numeric card values (if deck supports it).
- `median`: Median of numeric card values.
- `highest`: Maximum value.
- `lowest`: Minimum value.
- `suggestedEstimate`: Rounded average (e.g. 7.2 → 7, 7.8 → 8); used when facilitator records final estimate.
- `voteDistribution`: `Record<cardValue, count>` — how many participants voted for each value (e.g. "3 voted 5, 2 voted 8, 1 voted 13").

**Note:** T-shirt sizes (XS, S, M, L, XL) may need mapping to numbers for averaging (e.g. 1, 2, 3, 4, 5).

**Card descriptions:** If `Room.deckDescriptions` exists, descriptions are hidden from participants until `Round.state = REVEALED`. Before reveal, participants see only card values.

### 8.2 Common Queries

- **Active participants in room:** `SELECT * FROM participants WHERE room_id = ? AND is_active = 1`
- **Votes for current round:** `SELECT * FROM votes WHERE round_id = ? AND is_revealed = 0` (before reveal)
- **Items with final estimates:** `SELECT * FROM items WHERE room_id = ? AND final_estimate IS NOT NULL ORDER BY "order"`
- **Session history:** `SELECT * FROM sessions WHERE user_id = ? ORDER BY closed_at DESC` (post-MVP)

---

## 9. Data Migration (MVP → Post-MVP)

When adding accounts:
1. Add `User` table.
2. Add `user_id` columns to `Room`, `Participant`, `Session`.
3. Migrate existing sessions: link facilitator’s `Participant.userId` → `User.id` if email matches.
4. Allow anonymous rooms to remain; new rooms can require account (optional).

---

## 10. Reference to Spec

- **What data is needed:** Derived from `spec.MD` user stories and business rules.
- **How to use:** See `configuration.MD` for spec-driven implementation.
- **Stack:** See `quickstart.MD` for database choices (SQLite MVP, Postgres later).

When implementing data access, ensure:
- Votes remain secret until reveal (query `Round.state`).
- Each item has exactly one final estimate (enforce `Item.finalEstimate` uniqueness per item).
- Only facilitator can reveal/close (check `Participant.role`).
